<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Entregadores</title>
  <!-- Vuetify e √çcones -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.6/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.6/dist/vuetify.min.js"></script>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body>
  <div id="app">
    <v-app>
      <v-app-bar app color="primary" dark elevation="4" class="app-bar-modern">
        <v-app-bar-nav-icon v-if="isAuthenticated" @click="drawer = !drawer"></v-app-bar-nav-icon>
        <v-icon class="mr-2">mdi-truck-fast</v-icon>
        <v-toolbar-title class="font-weight-bold">Bem-vindo, {{ usuario.nome || 'Admin' }}</v-toolbar-title>
        <v-spacer></v-spacer>
        <v-btn v-if="isAuthenticated" color="error" @click="logout" class="logout-btn" rounded>
          <v-icon left>mdi-logout</v-icon>
          Sair
        </v-btn>
      </v-app-bar>

      <v-navigation-drawer v-if="isAuthenticated" v-model="drawer" app class="navigation-drawer-modern">
        <div class="drawer-header pa-4">
          <v-icon large color="primary">mdi-truck-delivery</v-icon>
          <h3 class="mt-2 primary--text">Entregadores</h3>
        </div>
        <v-divider></v-divider>
        <v-list nav>
          <v-list-item
            @click="tela_atual = 'dashboard'"
            :class="{'active-menu-item': tela_atual === 'dashboard'}"
            class="menu-item-hover">
            <v-list-item-icon><v-icon color="primary">mdi-view-dashboard</v-icon></v-list-item-icon>
            <v-list-item-content>
              <v-list-item-title class="font-weight-medium">Dashboard</v-list-item-title>
            </v-list-item-content>
          </v-list-item>
          <v-list-item
            @click="tela_atual = 'perfil'"
            :class="{'active-menu-item': tela_atual === 'perfil'}"
            class="menu-item-hover">
            <v-list-item-icon><v-icon color="primary">mdi-account</v-icon></v-list-item-icon>
            <v-list-item-content>
              <v-list-item-title class="font-weight-medium">Perfil</v-list-item-title>
            </v-list-item-content>
          </v-list-item>
          <v-list-item
            @click="tela_atual = 'historico'"
            :class="{'active-menu-item': tela_atual === 'historico'}"
            class="menu-item-hover">
            <v-list-item-icon><v-icon color="primary">mdi-history</v-icon></v-list-item-icon>
            <v-list-item-content>
              <v-list-item-title class="font-weight-medium">Hist√≥rico</v-list-item-title>
            </v-list-item-content>
          </v-list-item>
          <v-list-item
            @click="tela_atual = 'notificacoes'"
            :class="{'active-menu-item': tela_atual === 'notificacoes'}"
            class="menu-item-hover">
            <v-list-item-icon><v-icon color="primary">mdi-bell</v-icon></v-list-item-icon>
            <v-list-item-content>
              <v-list-item-title class="font-weight-medium">Notifica√ß√µes</v-list-item-title>
            </v-list-item-content>
          </v-list-item>
          <v-list-item
            @click="tela_atual = 'configuracoes'"
            :class="{'active-menu-item': tela_atual === 'configuracoes'}"
            class="menu-item-hover">
            <v-list-item-icon><v-icon color="primary">mdi-cog</v-icon></v-list-item-icon>
            <v-list-item-content>
              <v-list-item-title class="font-weight-medium">Configura√ß√µes</v-list-item-title>
            </v-list-item-content>
          </v-list-item>
        </v-list>
      </v-navigation-drawer>

      <v-main>
        <v-container>
          <template v-if="tela_atual === 'dashboard'">
            <div class="page-header mb-6">
              <h2 class="text-h4 font-weight-bold primary--text">
                <v-icon large color="primary" class="mr-2">mdi-chart-box</v-icon>
                Dashboard
              </h2>
              <p class="text-subtitle-1 grey--text">Acompanhe suas estat√≠sticas em tempo real</p>
            </div>

            <v-card class="mb-6 filter-card" elevation="2">
              <v-card-text>
                <v-row align="center">
                  <v-col cols="12" md="5">
                    <v-text-field
                      v-model="filtros.dataInicio"
                      label="Data In√≠cio"
                      type="date"
                      outlined
                      dense
                      prepend-inner-icon="mdi-calendar"
                      hide-details
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12" md="5">
                    <v-text-field
                      v-model="filtros.dataFim"
                      label="Data Fim"
                      type="date"
                      outlined
                      dense
                      prepend-inner-icon="mdi-calendar"
                      hide-details
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12" md="2">
                    <v-btn color="primary" block @click="carregarIndicadores" elevation="2" large>
                      <v-icon left>mdi-filter</v-icon>
                      Filtrar
                    </v-btn>
                  </v-col>
                </v-row>
              </v-card-text>
            </v-card>

            <!-- Cards de Indicadores -->
            <v-row>
              <v-col cols="12" md="4">
                <v-card class="stat-card stat-card-blue" elevation="4" hover>
                  <v-card-text>
                    <div class="d-flex align-center justify-space-between mb-3">
                      <div>
                        <p class="text-overline mb-0 white--text">Entregas do Dia</p>
                        <h2 class="text-h3 font-weight-bold white--text">{{ indicadores.entregasDoDia }}</h2>
                      </div>
                      <v-avatar size="64" color="rgba(255,255,255,0.2)">
                        <v-icon size="40" color="white">mdi-truck-delivery</v-icon>
                      </v-avatar>
                    </div>
                    <v-divider class="divider-white"></v-divider>
                    <p class="text-caption white--text mb-0 mt-2">
                      <v-icon small color="white">mdi-information</v-icon>
                      Total de entregas realizadas hoje
                    </p>
                  </v-card-text>
                </v-card>
              </v-col>

              <v-col cols="12" md="4">
                <v-card class="stat-card stat-card-red" elevation="4" hover>
                  <v-card-text>
                    <div class="d-flex align-center justify-space-between mb-3">
                      <div>
                        <p class="text-overline mb-0 white--text">Cancelamentos</p>
                        <h2 class="text-h3 font-weight-bold white--text">{{ indicadores.cancelamentos }}</h2>
                      </div>
                      <v-avatar size="64" color="rgba(255,255,255,0.2)">
                        <v-icon size="40" color="white">mdi-close-circle</v-icon>
                      </v-avatar>
                    </div>
                    <v-divider class="divider-white"></v-divider>
                    <p class="text-caption white--text mb-0 mt-2">
                      <v-icon small color="white">mdi-information</v-icon>
                      Entregas canceladas no per√≠odo
                    </p>
                  </v-card-text>
                </v-card>
              </v-col>

              <v-col cols="12" md="4">
                <v-card class="stat-card stat-card-green" elevation="4" hover>
                  <v-card-text>
                    <div class="d-flex align-center justify-space-between mb-3">
                      <div>
                        <p class="text-overline mb-0 white--text">Ganhos</p>
                        <h2 class="text-h3 font-weight-bold white--text">R$ {{ parseFloat(indicadores.ganhos) }}</h2>
                      </div>
                      <v-avatar size="64" color="rgba(255,255,255,0.2)">
                        <v-icon size="40" color="white">mdi-cash-multiple</v-icon>
                      </v-avatar>
                    </div>
                    <v-divider class="divider-white"></v-divider>
                    <p class="text-caption white--text mb-0 mt-2">
                      <v-icon small color="white">mdi-information</v-icon>
                      Total acumulado no per√≠odo
                    </p>
                  </v-card-text>
                </v-card>
              </v-col>
            </v-row>
          </template>
          

          <template v-if="tela_atual === 'perfil1'">
            <h2>Perfil do Usu√°rio</h2>
            <v-card v-if="usuario && usuario.nome">
              <v-card-title>{{ usuario.nome }}</v-card-title>
              <v-card-text>
                <p>Email: {{ usuario.email }}</p>
                <p>Telefone: {{ usuario.telefone || 'N√£o informado' }}</p>
                <p>Status: {{ usuario.status || 'Ativo' }}</p>
              </v-card-text>
            </v-card>
            <v-alert v-else type="info">Carregando informa√ß√µes do usu√°rio...</v-alert>

               <!-- Modal para edi√ß√£o -->
          </template>

            <template v-if="tela_atual === 'perfil'">
                <h2>Perfil do Usu√°rio</h2>
                <v-card v-if="usuario && usuario.nome">
                  <v-card-title>{{ usuario.cliente_nome }}</v-card-title>
                  <v-card-text>
                    <p>Email: {{ usuario.email }}</p>
                    <p>Telefone: {{ usuario.telefone || 'N√£o informado' }}</p>
                    <p>Status: {{ usuario.status || 'Ativo' }}</p>
                  </v-card-text>
                  <v-card-actions>
                     <v-btn color="primary" @click="abrirModalEditar">Editar Usu√°rio</v-btn>
                  </v-card-actions>
                </v-card>
                <v-alert v-else type="info">Carregando informa√ß√µes do usu√°rio...</v-alert>
    
                <v-dialog v-model="modalEditar" max-width="500px">
                  <v-card>
                    <v-card-title>
                      <span class="text-h5">Editar Usu√°rio</span>
                    </v-card-title>
                    <v-card-text>
                      <v-form ref="form">
                        <v-text-field
                          v-model="form.nome"
                          label="Nome"
                          required
                        ></v-text-field>
                        <v-text-field
                          v-model="form.endereco"
                          label="Endere√ßo"
                        ></v-text-field>
                        <v-text-field
                        v-model="form.telefone"
                        label="telefone"
                      ></v-text-field>
                      <v-select
                      v-model="form.status"
                      :items="['pendente', 'finalizada', 'cancelada']"
                      label="Status"
                      required
                    ></v-select>
                        
                        <v-text-field
                        v-model="form.email"
                        label="E-mail"
                      ></v-text-field>
                      </v-form>
                    </v-card-text>
                    <v-card-actions>
                      <v-btn color="primary" @click="atualizarUsuario">Salvar</v-btn>
                      <v-btn text @click="modalEditar = false">Cancelar</v-btn>
                    </v-card-actions>
                  </v-card>
                </v-dialog>
                
              </template>
          
          

          

          <template v-if="tela_atual === 'bate_papo'">
            <v-container>
              <h2>Bate-Papo</h2>
              <h3>Cliente: Roger Neves</h3>
              <v-card>
                <!-- Exibi√ß√£o das mensagens -->
                <v-card-text class="chat-box">
                  <div v-for="mensagem in mensagens" :key="mensagem.id" 
                       :class="{'cliente': mensagem.enviadoPor === 'cliente', 'entregador': mensagem.enviadoPor === 'entregador'}" 
                       class="mensagem">
                    <strong>{{ mensagem.enviadoPor === 'cliente' ? 'Voc√™' : 'Entregador' }}:</strong> {{ mensagem.texto }}
                  </div>
                </v-card-text>
          
                <!-- Campo de envio -->
                <v-card-actions>
                  <v-text-field 
                    v-model="novaMensagem"
                    label="Digite sua mensagem"
                    outlined
                    dense
                    hide-details
                    class="campo-mensagem"
                    @keyup.enter="enviarMensagem"
                  ></v-text-field>
                  <v-btn color="primary" @click="enviarMensagem">Enviar</v-btn>
                </v-card-actions>
                
                <!-- Bot√£o para o entregador confirmar que est√° com o pedido -->
                <v-card-actions v-if="statusPedido === 'aceito' && !pedidoColetado">
                  <v-btn color="success" @click="confirmarColeta">
                    J√° estou com o pedido
                  </v-btn>
                </v-card-actions>
              </v-card>
            </v-container>
          </template>

          <template v-if="tela_atual === 'detalhes_pedido'">
            <v-container>
                <h2>Detalhes da Entrega</h2>
                <v-card>
                    <v-card-title class="headline">
                        Pedido #{{ entregaAtual?.identify || 'N/A' }}
                    </v-card-title>
                    <v-card-text>
                        <div>
                            <strong>Cliente:</strong> {{ entregaAtual?.client?.name || 'N/A' }}
                        </div>
                        <div>
                            <strong>Endere√ßo:</strong> {{ entregaAtual?.client?.endereco || 'N/A' }}
                        </div>
                        <div>
                            <strong>Contato:</strong> {{ entregaAtual?.client?.telefone || 'N/A' }}
                        </div>
        
                        <!-- Verifica se entregaAtual.products existe e tem itens antes de acessar -->
                        <div v-if="entregaAtual?.products?.length">
                            <strong>Produto:</strong> {{ entregaAtual.products[0].title || 'N/A' }}
                        </div>
                        <div v-if="entregaAtual?.products?.length">
                            <strong>Pre√ßo:</strong> R$ {{ entregaAtual.products[0].price ? entregaAtual.products[0].price.toFixed(2) : '0.00' }}
                        </div>
                        <div v-if="entregaAtual?.products?.length">
                            <strong>Descri√ß√£o:</strong> {{ entregaAtual.products[0].description || 'N/A' }}
                        </div>
                        <div v-else>
                            <strong>Produto:</strong> Nenhum produto dispon√≠vel.
                        </div>

                        <v-text-field
                        v-model="codigoCliente"
                        label="C√≥digo do Cliente"
                        outlined
                        dense
                        placeholder="Insira o c√≥digo recebido do cliente"
                      />
                    </v-card-text>
                    <v-card-actions>
                   
                        <v-btn color="success" @click="confirmarEntrega">Confirmar Entrega</v-btn>
                        <v-btn color="error" @click="cancelarEntrega">Cancelar</v-btn>
                    </v-card-actions>
                </v-card>
            </v-container>
        </template>
        
        
        
          

          <template v-if="tela_atual === 'historico'">
            <v-container>
              <h2>Entregas do Usu√°rio</h2>
              <!-- <v-alert v-if="erro" type="error" dismissible>{{ erro }}</v-alert> -->
          
              <v-data-table
                v-if="entregas.length"
                :headers="headers"
                :items="entregas"
                class="elevation-1"
              >
                <template v-slot:item.data_entrega="{ item }">
                  {{ formatarData(item.data_entrega) }}
                </template>
                <template v-slot:item.pedido="{ item }">
                  <v-card outlined class="pa-3">
                    <div>
                      <strong>Cliente:</strong> {{ item.pedido.cliente_nome }}
                    </div>
                    <div>
                      <strong>Endere√ßo:</strong> {{ item.pedido.endereco_entrega }}
                    </div>
                    <div>
                      R$ {{ entregaAtual?.pedido?.valor }}
                    </div>
                    <div>
                      <strong>Detalhes:</strong> {{ item.pedido.detalhes }}
                    </div>
                  </v-card>
                </template>
                <template v-slot:no-data>
                  <v-alert type="info" dismissible>Nenhuma entrega encontrada.</v-alert>
                </template>
              </v-data-table>
            </v-container>
          </template>

                <template v-slot:no-data>
                  <v-alert type="info" dismissible>Nenhuma entrega encontrada.</v-alert>
                </template>
              </v-data-table>
            </v-container>
          </template>
          
          <template v-if="tela_atual === 'notificacoes'">
            <h2>Notifica√ß√µes de Entregas</h2>
            <v-alert v-if="!entregas.length" type="info">Nenhuma entrega pendente.</v-alert>
            <v-list v-else>
              <v-list-item v-for="entrega in entregas" :key="entrega.id" @click="mostrarDetalhesEntrega(entrega)">
                <v-list-item-icon><v-icon>mdi-truck</v-icon></v-list-item-icon>
                <v-list-item-content>
                  <v-list-item-title>Entrega #{{ entrega.id }}</v-list-item-title>
                  <v-list-item-subtitle>{{ entrega.pedido.cliente_nome }}</v-list-item-subtitle>
                </v-list-item-content>
              </v-list-item>
            </v-list>
          </template>
          <template v-if="tela_atual === 'configuracoes'">
            <h2>Configura√ß√µes</h2>
            <p>Aqui voc√™ pode alterar suas prefer√™ncias e dados do sistema.</p>
            <v-card>
              <v-card-title>Alterar Senha</v-card-title>
              <v-card-text>
                <v-text-field label="Senha Atual" type="password"></v-text-field>
                <v-text-field label="Nova Senha" type="password"></v-text-field>
                <v-btn color="primary">Salvar</v-btn>
              </v-card-text>
            </v-card>
          </template>

          <v-dialog v-model="modalVisivel" max-width="700" persistent transition="dialog-transition">
            <v-card class="modal-card-modern">
              <v-card-title class="modal-header primary white--text">
                <v-icon left color="white" large>mdi-package-variant</v-icon>
                <span class="text-h5 font-weight-bold">Nova Entrega Dispon√≠vel</span>
                <v-spacer></v-spacer>
                <v-btn icon dark @click="recusarEntrega">
                  <v-icon>mdi-close</v-icon>
                </v-btn>
              </v-card-title>

              <v-card-text class="pa-6">
                <v-alert type="info" border="left" colored-border class="mb-4">
                  <div class="d-flex align-center">
                    <v-icon left>mdi-bell-ring</v-icon>
                    <strong>Voc√™ recebeu um novo pedido de entrega!</strong>
                  </div>
                </v-alert>

                <v-row>
                  <v-col cols="12">
                    <div class="info-section mb-4">
                      <h4 class="text-h6 primary--text mb-3">
                        <v-icon color="primary">mdi-account</v-icon>
                        Informa√ß√µes do Cliente
                      </h4>
                      <v-list dense class="transparent">
                        <v-list-item>
                          <v-list-item-icon><v-icon color="primary">mdi-account-circle</v-icon></v-list-item-icon>
                          <v-list-item-content>
                            <v-list-item-subtitle>Nome</v-list-item-subtitle>
                            <v-list-item-title class="font-weight-bold">{{ entregaAtual?.client?.name || 'N/A' }}</v-list-item-title>
                          </v-list-item-content>
                        </v-list-item>
                        <v-list-item>
                          <v-list-item-icon><v-icon color="primary">mdi-map-marker</v-icon></v-list-item-icon>
                          <v-list-item-content>
                            <v-list-item-subtitle>Endere√ßo</v-list-item-subtitle>
                            <v-list-item-title class="font-weight-bold">{{ entregaAtual?.client?.endereco || 'N/A' }}</v-list-item-title>
                          </v-list-item-content>
                        </v-list-item>
                        <v-list-item>
                          <v-list-item-icon><v-icon color="primary">mdi-phone</v-icon></v-list-item-icon>
                          <v-list-item-content>
                            <v-list-item-subtitle>Contato</v-list-item-subtitle>
                            <v-list-item-title class="font-weight-bold">{{ entregaAtual?.client?.telefone || 'N/A' }}</v-list-item-title>
                          </v-list-item-content>
                        </v-list-item>
                      </v-list>
                    </div>
                  </v-col>

                  <v-col cols="12">
                    <v-divider></v-divider>
                  </v-col>

                  <v-col cols="12">
                    <div class="info-section">
                      <h4 class="text-h6 primary--text mb-3">
                        <v-icon color="primary">mdi-package</v-icon>
                        Detalhes do Produto
                      </h4>
                      <v-card outlined class="product-card">
                        <v-card-text>
                          <div class="d-flex align-center justify-space-between mb-2">
                            <span class="text-subtitle-2 grey--text">Produto</span>
                            <span class="font-weight-bold">{{ entregaAtual?.products[0]?.title || 'N/A' }}</span>
                          </div>
                          <div class="d-flex align-center justify-space-between mb-2">
                            <span class="text-subtitle-2 grey--text">Pre√ßo</span>
                            <span class="font-weight-bold green--text text-h6">
                              R$ {{ entregaAtual?.products?.[0]?.price ? entregaAtual.products[0].price.toFixed(2) : '0.00' }}
                            </span>
                          </div>
                          <v-divider class="my-2"></v-divider>
                          <div>
                            <span class="text-subtitle-2 grey--text">Descri√ß√£o</span>
                            <p class="mb-0 mt-1">{{ entregaAtual?.products[0]?.description || 'Sem descri√ß√£o' }}</p>
                          </div>
                        </v-card-text>
                      </v-card>
                    </div>
                  </v-col>
                </v-row>
              </v-card-text>

              <v-divider></v-divider>

              <v-card-actions class="pa-4">
                <v-btn color="error" text large @click="recusarEntrega">
                  <v-icon left>mdi-close-circle</v-icon>
                  Recusar
                </v-btn>
                <v-spacer></v-spacer>
                <v-btn color="success" large elevation="2" @click="aceitarEntrega">
                  <v-icon left>mdi-check-circle</v-icon>
                  Aceitar Entrega
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-dialog>
          
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script>
     const userId = localStorage.getItem('user_id');
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: () => ({
        pedidoId:"",
        codigoCliente:'',
        erro:[],
        email:"",
        mensagens: [
        { id: 1, enviadoPor: 'entregador', texto: 'Ol√°, estou a caminho da loja.' },
        { id: 2, enviadoPor: 'cliente', texto: '√ìtimo, obrigado!' }
      ],
      novaMensagem: '',
      statusPedido: 'aceito', // Status do pedido: aceito, coletado, entregue
      pedidoColetado: false   // Vari√°vel para controlar a coleta do pedido
    ,
    confirmarColeta :false,
      novaMensagem: '',
      form: {
        nome: '',
        endereco: '',
        email: '',
        telefone:"",
      },
        entregas :[],
        modalVisivel: false,
        modalEditar :false,
        entregaAtual: null, // Dados da entrega exibida no modal
        socket: null, // Inst√¢ncia do Socket.IO
        drawer: false,
        usuario: {}, // Dados do usu√°rio logado
        filtros: {
          dataInicio: new Date().toISOString().split('T')[0], // Data atual no formato YYYY-MM-DD
          dataFim: new Date().toISOString().split('T')[0],
        },
        headers: [
        { text: "ID", value: "id" },
        { text: "Status", value: "status" },
        { text: "Data de Entrega", value: "data_entrega" },
        { text: "Pedido Detalhes", value: "pedido" },
      ],
        indicadores: {
          entregasDoDia: 0,
          cancelamentos: 0,
          ganhos: 0,
        },
        tela_atual: 'dashboard', // Estado inicial da tela
      }),
      mounted() {
        this.checkAuthentication()
        this.carregarUsuario()
        this.carregarIndicadores()
        this.carregarEntregas()
        setTimeout(() => {
                   this.connectSocket();
                    
                }, 2000);
        
        },
        beforeDestroy() {
        // Desconecta o Socket.IO ao destruir o componente
        if (this.socket) {
          this.socket.disconnect();
        }
         if (!this.isAuthenticated) {
              window.location.href = 'login.html'; // Voc√™ pode substituir '/login' pela URL real da sua tela de login
        }
        
       
      },
      computed: {
        isAuthenticated() {
          return !!localStorage.getItem('token');
        },
      },
      methods: {
        confirmarColeta() {
      this.pedidoColetado = true;
      this.statusPedido = 'coletado';
      this.mensagens.push({
        id: this.mensagens.length + 1,
        enviadoPor: 'entregador',
        texto: 'Estou com o pedido e a caminho da entrega.'
      });
    },
        enviarMensagem() {
          if (this.novaMensagem.trim() !== '') {
            this.mensagens.push({
              id: this.mensagens.length + 1,
              texto: this.novaMensagem,
              enviadoPor: 'cliente', // Define quem enviou
            });
            this.novaMensagem = '';
          }
    },
    checkAuthentication() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
      }
    },
    connectSocket() {
      this.socket = io('https://www.comunidadeppg.com.br:3000');
      this.socket.on('connect', () => {
        console.log('Conectado ao servidor Socket.IO.');
      });



      this.socket.on('enviarpedidoentregadores', (data) => {
        console.log('pedido para entregador:', data);
        this.mostrarDetalhesEntrega(data);
        
        this.ativarAudio()
        this.reproduzirSomNotificacao()
    
     });

   



                    this.socket.on('disconnect', () => {
                        console.log('Desconectado do servidor Socket.IO.');
                    });
  
  
},
ativarAudio() {
    this.audioNotificacao = new Audio('/audio/notificacao.mp3');
    this.audioNotificacao.play().then(() => {
      this.audioAtivado = true;
     
    }).catch((e) => {
      console.error('Erro ao ativar √°udio:', e);
    });
  },
reproduzirSomNotificacao() {
  const audio = new Audio('/audio/notificacao.mp3');

    audio.play()
      .then(() => {
        console.log('üîä Som reproduzido com sucesso.');
      })
      .catch((error) => {
        console.error('Erro ao reproduzir o som:', error);
      });
  },
enviarNotificacaoPush(entrega) {
  const titulo = `üöö Novo pedido recebido!`;
  const corpo = `Cliente: ${entrega.client.name}\nProduto: ${entrega.products[0]?.title || 'N√£o informado'}`;

  new Notification(titulo, {
    body: corpo,
    icon: '/img/favicon.png', 
  });
},
mostrarDetalhesEntrega(entrega) {   
 // this.enviarNotificacaoPush(entrega);    hmn       
        this.entregaAtual = entrega;
        this.modalVisivel = true;
  },
  abrirModalEditar() {
     this.modalEditar = true;
    },
  confirmarEntrega() {

    if (!this.entregaAtual || !this.entregaAtual.identify) {
        alert('üö® Nenhuma entrega v√°lida selecionada.');
        return;
    }

    if(this.codigoCliente === '') {
        alert('‚ö†Ô∏è Por favor, informe o c√≥digo do cliente.');
        return;
    }

    const url = 'https://admindelivery.comunidadeppg.com.br/api/confirmarentrega/' + this.codigoCliente;

    const payload = {
        entregador_id: this.userId,
        status: 'done'
    };

axios.post(url, payload)
    .then((response) => {
      this.inserirEntrega(this.pedidoId) 
        alert('‚úÖ Muito obrigado pela entrega!');
        this.tela_atual = 'dashboard';
    })
    .catch((error) => {
        if (error.response) {
            if (error.response.status === 404) {
                alert('‚ö†Ô∏è Pedido n√£o encontrado. Por favor, verifique o c√≥digo informado.');
            } else if (error.response.status === 422) {
                alert('‚ö†Ô∏è Dados inv√°lidos. Verifique as informa√ß√µes enviadas.');
            } else {
                alert('‚ö†Ô∏è Ocorreu um erro inesperado (' + error.response.status + ').');
            }
        } else {
            alert('‚ö†Ô∏è Falha na conex√£o com o servidor.');
        }

        console.error('üö® Erro ao confirmar entrega:', error);
    });
},

enviarNotificacaoEntregaConfirmada(emailCliente) {
    console.log('üì© Enviando notifica√ß√£o de entrega confirmada...');
    const url = 'https://admindelivery.comunidadeppg.com.br/api/enviarnotificacao';

    const payload = {
        email: emailCliente,
        mensagem: "Seu pedido foi entregue com sucesso! Obrigado por escolher nosso servi√ßo.",
    };

    axios.post(url, payload)
        .then((response) => {
            console.log('‚úÖ Notifica√ß√£o de entrega confirmada enviada:', response.data);
        })
        .catch((error) => {
            console.error('üö® Erro ao enviar notifica√ß√£o de entrega confirmada:', error);
        });
},
cancelarEntrega()
{
  console.log('Entrega Cancelada');
},
async aceitarEntrega() {
    // Garante que a entrega e os produtos existem
    if (!this.entregaAtual || !this.entregaAtual.products || this.entregaAtual.products.length === 0) {
        console.error('üö® Erro: entregaAtual ou products est√£o indefinidos ou vazios.');
        return;
    }

    // Criptografa o c√≥digo da entrega (caso seja necess√°rio)
    this.codigoCriptografado = btoa(this.entregaAtual.codigo_entrega);
    console.log('üîç Debug: entregaAtual antes da mudan√ßa de tela', this.entregaAtual);

    // Insere o pedido no banco
    const pedidoPayload = {
        cliente_nome: this.entregaAtual.client.name,
        endereco_entrega: this.entregaAtual.client.endereco,
        valor: this.entregaAtual.total,
        detalhes: JSON.stringify(this.entregaAtual.products), // Armazena os produtos
        status: "pendente",
        created_at: new Date().toISOString().replace('T', ' ').split('.')[0]
    };

    try {
        const response = await axios.post(
            'https://admindelivery.comunidadeppg.com.br/api/pedidos',
            pedidoPayload
        );

        if (response.status === 201) {
            console.log('‚úÖ Pedido registrado com sucesso:', response.data);
            alert('‚úÖ Pedido aceito!');
            console.log(response.data.pedido.id)
            this.pedidoId = response.data.pedido.id
            // Atualiza a tela
            this.tela_atual = 'detalhes_pedido';
            this.modalVisivel = false;
        } else {
            alert('‚ùå Erro ao aceitar o pedido.');
        }
    } catch (error) {
        console.error('üö® Erro ao aceitar o pedido:', error);
        alert('‚ö†Ô∏è Erro ao aceitar o pedido. Verifique sua conex√£o.');
    }
},

enviarNotificacaoProdutoACaminho(emailCliente) {
    console.log('Enviando notifica√ß√£o de pedido a caminho...');
    const url = 'https://admindelivery.comunidadeppg.com.br/api/enviarnotificacao';
    
    const payload = {
        email: emailCliente,
        mensagem: "Seu pedido j√° est√° a caminho!",
    };

    axios.post(url, payload)
        .then((response) => {
            console.log('Notifica√ß√£o enviada com sucesso:', response.data);
        })
        .catch((error) => {
            console.error('Erro ao enviar notifica√ß√£o:', error);
        });
},
inserirPedido(clienteNome, enderecoEntrega, valor, detalhes) {
    const payload = {
        cliente_nome: clienteNome,
        endereco_entrega: enderecoEntrega,
        valor: valor,
        detalhes: detalhes,
        status: "pendente",
        created_at: new Date().toISOString().replace('T', ' ').split('.')[0]
    };

    fetch('https://admindelivery.comunidadeppg.com.br/api/pedidos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/plain, */*'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro ao criar pedido');
        }
        return response.json();
    })
    .then(data => {
        console.log('Pedido criado com sucesso:', data);
        this.pedidoId = data.pedido.id
        alert('Pedido criado com sucesso!'+data.pedido.id);
    })
    .catch(error => {
        console.error('Erro ao criar pedido:', error);
        alert('Erro ao criar pedido.');
    });
},
inserirEntrega() {
    const payload = {
        usuario_id: localStorage.getItem('user_id'),
        pedido_id: this.pedidoId,
        status: "pendente",
        data_entrega: new Date().toISOString().replace('T', ' ').split('.')[0]
    };

    fetch('https://admindelivery.comunidadeppg.com.br/api/entregas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/plain, */*'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro ao aceitar entrega');
        }
        return response.json();
    })
    .then(data => {
        console.log('Entrega aceita com sucesso:', data);
        alert('Entrega aceita com sucesso!');
    })
    .catch(error => {
        console.error('Erro ao aceitar entrega:', error);
        alert('Erro ao aceitar entrega.');
    });
},
    atualizarUsuario() {
          fetch(`https://admindelivery.comunidadeppg.com.br/api/usuarios/`+localStorage.getItem('user_id'), {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(this.form),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Erro ao atualizar usu√°rio.');
          }
          return response.json();
        })
        .then((data) => {
          this.usuario = data; // Atualiza os dados do usu√°rio localmente
          this.modalEditar = false; // Fecha o modal
        })
        .catch((error) => {
          console.error('Erro ao atualizar usu√°rio:', error);
          alert('Falha ao atualizar o usu√°rio. Tente novamente.');
        });
    },
      recusarEntrega() {
        // L√≥gica para recusar a entrega
        console.log("Entrega recusada:", this.entregaAtual);
        this.modalVisivel = false;
        // Enviar solicita√ß√£o para a API (se necess√°rio)
        fetch(`https://admindelivery.comunidadeppg.com.br/api/entregas/${this.entregaAtual.id}/recusar`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json',
          },
        }).then(response => {
          if (!response.ok) {
            throw new Error("Erro ao recusar entrega");
          }
          return response.json();
        }).then(data => {
          console.log("Entrega recusada com sucesso:", data);
        }).catch(error => {
          console.error("Erro:", error);
        });
      },
        logout() {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        },
        carregarEntregas() {
          fetch('https://admindelivery.comunidadeppg.com.br/api/entregas/'+userId, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`, // Insere o token de autentica√ß√£o
              'Content-Type': 'application/json',
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`Erro na API: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              //console.log('Entregas do usu√°rio:', data); // Exibe as entregas no console
              this.entregas = data; // Atualiza a lista de entregas no estado
            })
            .catch((error) => {
              console.error('Erro ao carregar entregas:', error);
              this.entregas = []; // Limpa a lista em caso de erro
            });
        },
        formatarData(data) {
          if (!data) return "Data inv√°lida";
          const options = {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          };
          return new Date(data).toLocaleString("pt-BR", options);
        },
        carregarUsuario() {
       // console.log("Chamando carregarUsuario...");
        const userId = localStorage.getItem('user_id');
        // console.log("user_id:", userId);

        fetch('https://admindelivery.comunidadeppg.com.br/api/usuarios/' + userId)
          .then((response) => response.json())
          .then((data) => {
           // console.log("Dados do usu√°rio:", data);
            this.usuario = data;
            this.form = { ...data };
          })
          .catch((error) => {
            console.error('Erro ao carregar usu√°rio:', error);
          });
      },
        carregarIndicadores() {
        const params = new URLSearchParams(this.filtros).toString();

        fetch(`https://admindelivery.comunidadeppg.com.br/api/indicadores?${params}&user_id=`+userId, {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json',
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Erro na API: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
          // console.log('Indicadores carregados:', data);
            this.indicadores.entregasDoDia = data.entregas_do_dia;
            this.indicadores.cancelamentos = data.cancelamentos;
            this.indicadores.ganhos = parseFloat(data.ganhos || 0).toFixed(2);
          })
          .catch((err) => {
            console.error('Erro ao carregar indicadores:', err);
            this.indicadores = { entregasDoDia: 0, cancelamentos: 0, ganhos: 0 };
          });
      },

      },
    });
  </script>

<style>
  /* Fonte Global */
  * {
    font-family: 'Poppins', sans-serif !important;
  }

  /* Fundo da Aplica√ß√£o */
  .v-application {
    background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%) !important;
  }

  /* AppBar Moderna */
  .app-bar-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3) !important;
  }

  .logout-btn {
    transition: all 0.3s ease !important;
  }

  .logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
  }

  /* Navigation Drawer */
  .navigation-drawer-modern {
    background: white !important;
    box-shadow: 2px 0 20px rgba(0, 0, 0, 0.08) !important;
  }

  .drawer-header {
    text-align: center;
    border-bottom: 2px solid #f0f0f0;
    background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
  }

  .menu-item-hover {
    margin: 4px 8px;
    border-radius: 12px !important;
    transition: all 0.3s ease !important;
  }

  .menu-item-hover:hover {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%) !important;
    transform: translateX(5px);
  }

  .active-menu-item {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
  }

  .active-menu-item .v-list-item__title,
  .active-menu-item .v-icon {
    color: white !important;
  }

  /* Page Header */
  .page-header {
    animation: fadeInDown 0.5s ease;
  }

  /* Filter Card */
  .filter-card {
    border-radius: 16px !important;
    background: white !important;
    transition: all 0.3s ease !important;
  }

  .filter-card:hover {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12) !important;
  }

  /* Stat Cards com Gradientes */
  .stat-card {
    border-radius: 20px !important;
    transition: all 0.3s ease !important;
    animation: fadeInUp 0.6s ease;
    overflow: hidden;
    position: relative;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .stat-card:hover::before {
    opacity: 1;
  }

  .stat-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2) !important;
  }

  .stat-card-blue {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  }

  .stat-card-red {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
  }

  .stat-card-green {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
  }

  .divider-white {
    border-color: rgba(255, 255, 255, 0.3) !important;
  }

  /* Modal Moderna */
  .modal-card-modern {
    border-radius: 20px !important;
    overflow: hidden;
  }

  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    padding: 24px !important;
  }

  .product-card {
    border-radius: 12px !important;
    background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%) !important;
    border: none !important;
  }

  /* Chat Box */
  .chat-box {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 16px;
    padding: 16px;
    background: #f5f7fa;
    border-radius: 12px;
  }

  .mensagem {
    padding: 12px 16px;
    margin: 8px 0;
    border-radius: 16px;
    max-width: 70%;
    animation: messageSlide 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .cliente {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-left: auto;
    text-align: right;
    border-bottom-right-radius: 4px;
  }

  .entregador {
    background: white;
    color: #333;
    margin-right: auto;
    text-align: left;
    border-bottom-left-radius: 4px;
  }

  .campo-mensagem {
    flex: 1;
    margin-right: 8px;
  }

  /* Animations */
  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes messageSlide {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Data Table Styling */
  .v-data-table {
    border-radius: 16px !important;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
  }

  .v-data-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  }

  .v-data-table thead th {
    color: white !important;
    font-weight: 600 !important;
  }

  /* Buttons */
  .v-btn {
    border-radius: 12px !important;
    text-transform: none !important;
    font-weight: 500 !important;
    letter-spacing: 0.5px !important;
    transition: all 0.3s ease !important;
  }

  .v-btn:hover {
    transform: translateY(-2px);
  }

  .v-btn.v-btn--rounded {
    border-radius: 28px !important;
  }

  /* Text Fields */
  .v-text-field--outlined fieldset {
    border-radius: 12px !important;
    border-width: 2px !important;
  }

  .v-text-field--outlined:hover fieldset {
    border-color: #667eea !important;
  }

  /* Cards Gerais */
  .v-card {
    border-radius: 16px !important;
    transition: all 0.3s ease !important;
  }

  .v-card.elevation-2 {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
  }

  .v-card.elevation-4 {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12) !important;
  }

  /* Scrollbar Customizado */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  }

  /* Alert Styles */
  .v-alert {
    border-radius: 12px !important;
  }

  /* Responsive */
  @media (max-width: 960px) {
    .stat-card {
      margin-bottom: 16px;
    }

    .mensagem {
      max-width: 85%;
    }
  }
</style>
</body>
</html>
